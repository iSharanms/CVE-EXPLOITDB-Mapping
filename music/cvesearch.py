import os,sys,csv,subprocess,openpyxl
i=1
j=1
nmap=[]
exploitdb=[]
exploitdb=[]
def core(key,path,l,choice):
        result=""
        global exploitdb,i,j,nmap
        if key=="exploitdb" and choice!=2:
               res1= os.system('grep -R \"\''+l+'\'\" '+path)
               res2= os.system('grep -Riw \"'+"CVE-"+l+'\" '+path)
               result=res1 if res1 else res2
        if key=="nmap" and choice!=1:
               result= os.system('grep -R \"'+l+'\"'+path)
        fullpath=result.split(':')[0]
        id1=os.path.basename(fullpath)
        id1=os.path.splitext(id1)[0]
        if result and key=="exploitdb":
               result= "https://www.exploit-db.com/exploits/"+id1
               exploitdb.append(str(i)+" . "+"CVE-"+l+" => "+fullpath+" => "+result)
               i+=1
        if result and key=="nmap":
               result="https://github.com/nmap/nmap/tree/master/scripts/"+id1
               nmap.append(str(j)+" . "+"CVE-"+l+" => "+fullpath+" => "+result)
               j+=1

def search1(cves1,choice):
        cves1=set(cves1)
        cves1=list(cves1)
        cves=[x for x in cves1 if x!=""]
        for l in cves:
               l=l.rstrip()
               l=l[4:]
#               print("\033c")
               if l!="":
                      print("\033[1;32mSearching For \033[1;97mCVE-"+l)
                      for key,path in dirs.items():
                              core(key,path,l,choice)
def download(input1):
                print("Downloading/Updating the "+input1+" Database...")
                if os.path.isdir(input1):
                                os.system('rm -r '+input1)
                os.system('mkdir '+input1)
                if input1=="exploitdb":
                                command='git clone https://github.com/offensive-security/exploit-database.git '+input1
                else:
                                command='git clone https://github.com/nmap/nmap.git '+input1
                process = subprocess.Popen(command, shell=True, stdout=subprocess.PIPE)
                process.wait()
                os.system('find . -name \"*.db\" -type f -delete')
                print("Update Completed....")

def cvesearch(cves,update,choice):
                for key,path in dirs.items():
                                if os.path.isdir(path):
#                                                if update.lower()=='y' or update.lower()=='yes':
                                                if update:
                                                                download(key)
                                else:
                                                print(key+" Database Not Found")
                                                download(key)
                search1(cves,choice)
cves=[]
dirs={'exploitdb':'exploitdb-database/platforms','nmap':'nmap/scripts'}
nmapdir='nmap/scripts'
exploitdbdir='exploitdb/platforms'
basedir=os.getcwd()
def handle_uploaded_file(opt,file1,update,choice):
    file1=basedir+file1
    print("OPTION:"+str(opt)+"\nFile:"+str(file1)+"\nUpdate:"+str(update)+"\nChoice:"+str(choice))
    if opt == 0:
        print("Place the CSV in the same folder where executable is present")
        if os.path.isfile(file1):
            f=open(file1,'rt')
            reader=csv.reader(f,delimiter=',')
            for row in reader:
                cves.append(row[3])
                f.close()
                cvesearch(cves,update,choice)
        else:
            print("Invalid File Selected")
    if opt==1:
        print("Place the XLSX in the same folder where executable is present")
        if os.path.isfile(file1):
               wb = openpyxl.load_workbook(file1)
               ws = wb.get_sheet_by_name('Sheet1')
               for row in ws.iter_rows('A{}:A{}'.format(ws.min_row+2,ws.max_row)):
                   for cell in row:
                       cves.append(str(cell.value))
               cvesearch(cves,update,choice)
        else:
               print("Invalid File Selected")
    if opt == 2:
        print("Place the TEXT File in the same Folder "+file1)
        if os.path.isfile(file1):
            print("file detected")
            with open(file1) as f:
                for l in f.readlines():
                    cves.append(l)
            cvesearch(cves,update,choice)
        else:
            print("Invalid File Selected")
    if opt == 3:
        print("Single CVE Search")
        inp = input("Enter the full CVE number including CVE keyword: ")
        cves.append(inp)
        cvesearch(cves)
    #print("\033c")
    print("\033[1;31mNumber of CVE scanned: \033[1;m"+str(len(cves)))
    print("\033[1;31mNumber of CVE Found: \033[1;m"+str(len(exploitdb)))
    print("\033[1;31mExploit Available for below CVE")
    for i in exploitdb:
       print("\033[1;m"+str(i))
    print("\033[1;31mNMAP Script Available for below CVE")
    for i in nmap:
       print("\033[1;m"+str(i))

