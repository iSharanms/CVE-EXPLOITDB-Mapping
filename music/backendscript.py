#!/usr/bin/python
import os, csv, subprocess
i=1
j=1
nmap=[]
exploitdb=[]
def core(key,path,l):
                global exploitdb,i,j,nmap
                result= commands.getoutput('grep -R \"'+l+'\" '+path)
                fullpath=result.split(':')[0]
                id1=os.path.basename(fullpath)
                id1=os.path.splitext(id1)[0]
                if result and key=="exploitdb":
                                result= "https://www.exploit-db.com/exploits/"+id1
                                exploitdb.append(str(i)+" . "+"CVE-"+l+" => "+fullpath+" => "+result)
                                i+=1
                if result and key=="nmap":
                                result="https://github.com/nmap/nmap/tree/master/scripts/"+id1
                                nmap.append(str(j)+" . "+"CVE-"+l+" => "+fullpath+" => "+result)
                                j+=1
def search1(cves):
                cves=set(cves)
                cves=list(cves)
                for l in cves:
                                l=l.rstrip()
                                l=l[4:]
                                print("\033c")
                                print("\033[1;32mSearching For \033[1;97mCVE-"+l)
                                for key,path in dirs.iteritems():
                                                core(key,path,l)
def download(input1):
                print("Downloading/Updating the "+input1+" Database...")
                if os.path.isdir(input1):
                                os.system('rm -r '+input1)
                os.system('mkdir '+input1)
                if input1=="exploitdb":
                                command='git clone https://github.com/offensive-security/exploit-database.git '+input1
                else:
                                command='git clone https://github.com/nmap/nmap.git '+input1
                process = subprocess.Popen(command, shell=True, stdout=subprocess.PIPE)
                process.wait()
                os.system('find . -name \"*.db\" -type f -delete')
                print("Update Completed....")

def cvesearch(cves):
                for key,path in dirs.iteritems():
                                if os.path.isdir(path):
                                                press=input(key+" Database Found\tPress Y to Update: ")
                                                if press.lower()=='y' or press.lower()=='yes':
                                                                download(key)
                                else:
                                                print(key+" Database Not Found")
                                                download(key)
                search1(cves)

cves=[]
dirs={'exploitdb':'exploitdb/platforms','nmap':'nmap/scripts'}
nmapdir='nmap/scripts'
exploitdbdir='exploitdb/platforms'
print("1. Protecode CSV Output")
print("2. Text File")
print("3. Single CVE Search")
opt=input("Choose the above option as input:")
if opt=="1":
                print("Place the CSV in the same folder where executable is present")
                file=input("\033[1;33mEnter the filename: ")
                if os.path.isfile(file):
                                f=open(file,'rt')
                                reader=csv.reader(f,delimiter=',')
                                for row in reader:
                                                cves.append(row[3])
                                f.close()
                                cvesearch(cves)
                else:
                                print("Invalid File Selected")
if opt=="2":
                print("Place the TEXT File in the same Folder")
                file=input("\033[1;33mEnter the file name:")
                if os.path.isfile(file):
                                with open(file) as f:
                                                for l in f.readlines():
                                                                cves.append(l)
                                cvesearch(cves)
                else:
                                print("Invalid File Selected")
if opt=="3":
                print("Single CVE Search")
                inp=input("Enter the full CVE number including CVE keyword: ")
                cves.append(inp)
                cvesearch(cves)
print("\033c")
print("\033[1;31mNumber of CVE scanned: \033[1;m"+str(len(cves)))
print("\033[1;31mNumber of CVE Found: \033[1;m"+str(len(exploitdb)))
print("\033[1;31mExploit Available for below CVE")
for i in exploitdb:
    print("\033[1;m"+str(i))
print("\033[1;31mNMAP Script Available for below CVE")
for i in nmap:
    print("\033[1;m"+str(i))
